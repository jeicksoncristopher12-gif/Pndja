<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Song Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Mantenemos tus estilos originales que están excelentes */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary: #667eea; --primary-dark: #764ba2; --secondary: #f093fb; --accent: #4facfe; --text: #333; --text-light: #666; --bg: #f8f9fa; --card-bg: #ffffff; --shadow: 0 10px 30px rgba(0,0,0,0.1); }
        body { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); min-height: 100vh; padding: 20px; color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 3.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); background: linear-gradient(45deg, #fff, #e3f2fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { font-size: 1.2rem; opacity: 0.9; max-width: 600px; margin: 0 auto; }
        .app-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: var(--card-bg); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow); min-height: 600px; }
        .input-section { padding: 40px; background: linear-gradient(135deg, var(--card-bg) 0%, #f8f9fa 100%); }
        .output-section { padding: 40px; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); font-size: 1rem; }
        input, textarea { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: white; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 120px; resize: vertical; font-family: inherit; }
        .generate-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .result-container { text-align: center; width: 100%; }
        .thumbnail-container { position: relative; display: inline-block; margin-bottom: 25px; }
        .thumbnail { width: 300px; height: 300px; border-radius: 15px; object-fit: cover; box-shadow: var(--shadow); border: 5px solid white; background: #eee; }
        .download-overlay { position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.95); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .download-overlay:hover { background: white; transform: scale(1.1); }
        .download-icon { color: var(--primary); font-size: 1.4rem; }
        .status-message { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 500; width: 100%; }
        .status-loading { background: #e3f2fd; color: #1976d2; border-left: 4px solid #1976d2; }
        .status-success { background: #e8f5e8; color: #2e7d32; border-left: 4px solid #2e7d32; }
        .status-error { background: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .url-container { margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        .url-text { font-size: 0.9rem; word-break: break-all; color: #495057; margin-bottom: 8px; }
        .copy-btn { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease; }
        .copy-btn:hover { background: var(--primary-dark); }
        @media (max-width: 968px) { .app-container { grid-template-columns: 1fr; } .header h1 { font-size: 2.5rem; } .thumbnail { width: 250px; height: 250px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-music"></i> AI Song Generator</h1>
            <p>Transform your ideas into music with artificial intelligence</p>
        </div>
        
        <div class="app-container">
            <div class="input-section">
                <form id="songForm">
                    <div class="form-group">
                        <label for="prompt"><i class="fas fa-lightbulb"></i> Song Theme/Prompt</label>
                        <input type="text" id="prompt" name="prompt" placeholder="Describe the style, mood, or theme..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="lyrics"><i class="fas fa-pen"></i> Your Lyrics</label>
                        <textarea id="lyrics" name="lyrics" placeholder="Enter your song lyrics here..." required></textarea>
                    </div>
                    
                    <button type="submit" class="generate-btn" id="generateBtn">
                        <i class="fas fa-magic"></i> Generate Song
                    </button>
                </form>
            </div>
            
            <div class="output-section">
                <div id="initialState">
                    <i class="fas fa-music" style="font-size: 4rem; color: #667eea; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 10px;">Your Song Awaits</h3>
                    <p style="color: #888; text-align: center;">Enter your prompt and lyrics. DEVELOPER BY: @hardhackar007</p>
                </div>
                
                <div id="resultContainer" class="result-container hidden">
                    <div class="thumbnail-container">
                        <img id="thumbnail" class="thumbnail" src="" alt="Generated thumbnail">
                        <div class="download-overlay" id="downloadBtn">
                            <i class="fas fa-download download-icon"></i>
                        </div>
                    </div>
                    <h3 id="songTitle" style="margin-bottom: 10px;">Your AI Generated Song</h3>
                    <p id="songStatus" style="color: #666;"></p>
                    
                    <div class="url-container">
                        <div class="url-text" id="songUrlText">Song URL: <span id="songUrl"></span></div>
                        <button class="copy-btn" id="copyUrlBtn">
                            <i class="fas fa-copy"></i> Copy URL
                        </button>
                    </div>
                </div>
                
                <div id="statusMessage" class="status-message hidden"></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('songForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const prompt = document.getElementById('prompt').value;
            const lyrics = document.getElementById('lyrics').value;
            const generateBtn = document.getElementById('generateBtn');
            const statusMessage = document.getElementById('statusMessage');
            const initialState = document.getElementById('initialState');
            const resultContainer = document.getElementById('resultContainer');
            
            // UI Inicial
            generateBtn.innerHTML = '<div class="loading-spinner"></div> Generating...';
            generateBtn.disabled = true;
            statusMessage.className = 'status-message status-loading';
            statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando con NoteGPT...';
            statusMessage.classList.remove('hidden');
            initialState.classList.add('hidden');
            resultContainer.classList.add('hidden');

            try {
                // LLAMADA A TU API DE PYTHON EN VERCEL
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, lyrics })
                });
                
                const result = await response.json();
                
                if (result.conversation_id) {
                    pollStatus(result.conversation_id);
                } else {
                    throw new Error('No se pudo obtener el ID de conversación');
                }
            } catch (error) {
                showError("Error: " + error.message);
            }
        });

        async function pollStatus(id) {
            const statusMessage = document.getElementById('statusMessage');
            let attempts = 0;

            const interval = setInterval(async () => {
                attempts++;
                statusMessage.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generando música... (${attempts * 5}s)`;

                try {
                    const res = await fetch(`/api/status?conversation_id=${id}`);
                    const data = await res.json();

                    // Si NoteGPT ya terminó la música
                    if (data.status === 'completed' || (data.data && data.data.audio_url)) {
                        clearInterval(interval);
                        showResult(data.data);
                    }
                } catch (e) {
                    console.error("Error revisando estado");
                }

                if (attempts > 30) { // Timeout tras 2.5 minutos
                    clearInterval(interval);
                    showError("La generación tardó demasiado.");
                }
            }, 5000);
        }

        function showResult(data) {
            const resultContainer = document.getElementById('resultContainer');
            const statusMessage = document.getElementById('statusMessage');
            
            document.getElementById('thumbnail').src = data.image_url;
            document.getElementById('songStatus').textContent = 'Song ready for download';
            
            // Acortador TinyURL igual al del "wey"
            const audioUrl = data.audio_url;
            fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(audioUrl)}`)
                .then(r => r.text())
                .then(shortUrl => {
                    document.getElementById('songUrl').textContent = shortUrl;
                    document.getElementById('copyUrlBtn').onclick = () => {
                        navigator.clipboard.writeText(shortUrl);
                        alert("¡Link copiado!");
                    };
                });

            document.getElementById('downloadBtn').onclick = () => window.open(audioUrl, '_blank');

            statusMessage.className = 'status-message status-success';
            statusMessage.innerHTML = '<i class="fas fa-check-circle"></i> ¡Música generada con éxito!';
            resultContainer.classList.remove('hidden');
            
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').innerHTML = '<i class="fas fa-magic"></i> Generate Song';
        }

        function showError(msg) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = 'status-message status-error';
            statusMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${msg}`;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').innerHTML = '<i class="fas fa-magic"></i> Generate Song';
        }
    </script>
</body>
</html>